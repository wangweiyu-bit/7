<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>代码中心 · 老王研究所</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
  <script defer src="../assets/js/main.js"></script>
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <section>
      <h2 class="section-title">代码中心 <span class="cat-ears"></span></h2>
      <div class="row">
        <input id="q" placeholder="搜索：名称/标签/类型" style="max-width:360px" />
        <select id="cat">
          <option value="">全部分类</option>
          <option>ImageJ 插件</option>
          <option>数据处理脚本</option>
          <option>图像分析宏</option>
        </select>
      </div>
      <div class="space"></div>
      <div id="list" class="grid"></div>
    </section>

    <section id="code-comments">
      <h2 class="section-title">讨论区</h2>
      <div class="card"><div class="card-body">
        <form class="row" style="align-items:flex-start;gap:8px">
          <textarea name="text" rows="3" placeholder="登录后可留言/提问"></textarea>
          <button class="btn" type="submit">发布</button>
        </form>
        <div class="space"></div>
        <div class="comments-list grid"></div>
      </div></div>
    </section>
  </main>
  <div id="footer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const data = await LW.fetchJSON('../data/code.json').catch(()=>[]);
      const listEl = document.getElementById('list');
      const qEl = document.getElementById('q');
      const catEl = document.getElementById('cat');
      function render(){
        const q = (qEl.value||'').toLowerCase();
        const cat = catEl.value;
        const arr = data.filter(x => (!cat || x.category===cat) && (!q || (x.title+x.desc+(x.tags||[]).join(' ')).toLowerCase().includes(q)));
        listEl.innerHTML = arr.map(x => `
          <div class=\"col-4\"><div class=\"card\"><div class=\"card-body\">
            <div class=\"row\"><strong>${x.title}</strong><span class=\"tag\">${x.category}</span></div>
            <p class=\"card-desc\">${x.desc}</p>
            <div class=\"row\">${(x.tags||[]).map(t=>`<span class=\\\"tag\\\">${t}</span>`).join('')}</div>
            <div class=\"card-actions\">
              ${x.free?`<a class=\"btn\" href=\"${x.link}\" download>下载</a>`:`<button class=\"btn primary\" onclick=\"pay('${x.id}')\">付费下载</button>`}
              ${x.docs?`<a class=\"btn\" href=\"${x.docs}\" target=\"_blank\">文档</a>`:''}
            </div>
          </div></div></div>`).join('');
      }
      qEl.addEventListener('input', render);
      catEl.addEventListener('change', render);
      window.pay = function(id){
        if(!LW.ensureAuth('premium')) return;
        alert('支付占位：资源 '+id+' 已解锁（示例）');
      }
      render();
      LW.initComments('code-comments','comments:code');
    });
  </script>
</body>
</html>


